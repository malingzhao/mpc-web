# Ed25519 BIP32 密钥派生

本项目为Ed25519曲线实现了BIP32兼容的分层确定性密钥派生功能，支持与阈值签名方案的集成。

## 功能特性

- ✅ **Ed25519 BIP32派生**: 支持Ed25519曲线的非硬化密钥派生
- ✅ **阈值签名集成**: 与Ed25519阈值签名方案无缝集成
- ✅ **批量派生**: 支持一次性派生多层级密钥路径
- ✅ **公钥一致性**: 确保所有参与方派生的公钥一致
- ✅ **安全验证**: 内置密钥验证和曲线检查
- ✅ **标准兼容**: 遵循BIP32标准的派生方法

## 核心组件

### Ed25519TssKey

Ed25519专用的TSS密钥结构，支持：
- 密钥份额管理
- 公钥点存储
- 链码管理
- 累积偏移量跟踪

### 主要方法

```go
// 创建新的Ed25519 TSS密钥
func NewEd25519TssKey(shareI *big.Int, publicKey *curves.ECPoint, chaincode string) (*Ed25519TssKey, error)

// 派生单个子密钥
func (tssKey *Ed25519TssKey) NewChildKey(childIdx uint32) (*Ed25519TssKey, error)

// 批量派生密钥路径
func (tssKey *Ed25519TssKey) DeriveChildKeys(path []uint32) (*Ed25519TssKey, error)

// 转换为Ed25519公钥对象
func (tssKey *Ed25519TssKey) ToEd25519PublicKey() *edwards.PublicKey
```

## 使用示例

### 基本密钥派生

```go
package main

import (
    "math/big"
    "github.com/decred/dcrd/dcrec/edwards/v2"
    "github.com/okx/threshold-lib/crypto/curves"
    "github.com/okx/threshold-lib/tss/key/bip32"
)

func main() {
    // 创建Ed25519曲线
    curve := edwards.Edwards()
    
    // 生成主私钥
    privateKey := new(big.Int)
    privateKey.SetString("123456789012345678901234567890", 10)
    
    // 计算公钥点
    publicKey := curves.ScalarToPoint(curve, privateKey)
    
    // 主链码
    chaincode := "0123456789abcdef0123456789abcdef0123456789abcdef0123456789abcdef"
    
    // 创建主TSS密钥
    masterKey, err := bip32.NewEd25519TssKey(privateKey, publicKey, chaincode)
    if err != nil {
        panic(err)
    }
    
    // 派生子密钥 m/0/1/2
    path := []uint32{0, 1, 2}
    childKey, err := masterKey.DeriveChildKeys(path)
    if err != nil {
        panic(err)
    }
    
    // 获取子密钥信息
    fmt.Printf("子密钥份额: %s\n", childKey.ShareI().String())
    fmt.Printf("子公钥X: %x\n", childKey.PublicKey().X.Bytes())
    fmt.Printf("子公钥Y: %x\n", childKey.PublicKey().Y.Bytes())
}
```

### 与阈值签名集成

```go
// 假设已经通过DKG生成了主密钥份额
shares := []*big.Int{share1, share2, share3}  // 来自DKG
masterPublicKey := publicKeyFromDKG           // 来自DKG
chaincode := "主链码"

// 为每个参与方创建BIP32主密钥
var masterKeys []*bip32.Ed25519TssKey
for i, share := range shares {
    masterKey, err := bip32.NewEd25519TssKey(share, masterPublicKey, chaincode)
    if err != nil {
        panic(err)
    }
    masterKeys = append(masterKeys, masterKey)
}

// 所有参与方派生相同的子密钥路径
derivationPath := []uint32{44, 60, 0, 0, 0}  // 以太坊地址路径
var childKeys []*bip32.Ed25519TssKey
for _, masterKey := range masterKeys {
    childKey, err := masterKey.DeriveChildKeys(derivationPath)
    if err != nil {
        panic(err)
    }
    childKeys = append(childKeys, childKey)
}

// 验证所有参与方的子公钥一致
basePublicKey := childKeys[0].PublicKey()
for i := 1; i < len(childKeys); i++ {
    if !basePublicKey.Equals(childKeys[i].PublicKey()) {
        panic("子公钥不一致")
    }
}

// 现在可以使用子密钥份额进行阈值签名
```

## 演示程序

项目包含三个演示程序：

### 1. Ed25519 BIP32基础演示
```bash
go run ed25519_bip32_demo.go
```
演示基本的Ed25519 BIP32密钥派生功能。

### 2. Ed25519阈值签名演示
```bash
go run ed25519_threshold_demo.go
```
演示完整的Ed25519阈值签名流程。

### 3. Ed25519阈值签名 + BIP32综合演示
```bash
go run ed25519_threshold_bip32_demo.go
```
演示Ed25519阈值签名与BIP32密钥派生的集成使用。

## 测试

运行Ed25519 BIP32相关测试：

```bash
go test ./tss/key/bip32 -v -run TestEd25519
```

## 技术细节

### 密钥派生算法

Ed25519 BIP32派生使用以下算法：

1. **偏移量计算**: `HMAC-SHA512("Ed25519 key share derivation:\n" | chaincode | publicKey | childIdx)`
2. **私钥派生**: `child_private_key = parent_private_key + offset (mod curve_order)`
3. **公钥派生**: `child_public_key = parent_public_key + offset * G`
4. **链码更新**: `child_chaincode = HMAC_result[32:64]`

### 安全考虑

- **非硬化派生**: 当前实现仅支持非硬化派生（索引 < 2^31）
- **密钥验证**: 自动验证派生的密钥是否有效
- **曲线检查**: 确保所有操作在正确的Ed25519曲线上进行
- **偏移量累积**: 跟踪累积偏移量以支持密钥恢复

### 限制

1. **硬化派生**: 不支持硬化派生（索引 >= 2^31）
2. **私钥恢复**: Ed25519的特殊性质使得直接私钥恢复有限制
3. **兼容性**: 专为Ed25519曲线设计，不兼容其他曲线

## 与ECDSA BIP32的区别

| 特性 | ECDSA BIP32 | Ed25519 BIP32 |
|------|-------------|---------------|
| 曲线 | secp256k1 | Ed25519 |
| 硬化派生 | 支持 | 不支持 |
| 私钥恢复 | 完全支持 | 有限制 |
| 性能 | 标准 | 更快 |
| 安全性 | 高 | 更高 |

## 文件结构

```
tss/key/bip32/
├── ed25519_tsskey.go      # Ed25519 BIP32实现
├── ed25519_tsskey_test.go # 单元测试
└── tsskey.go              # 原有ECDSA BIP32实现
```

## 贡献

欢迎提交Issue和Pull Request来改进Ed25519 BIP32功能。

## 许可证

本项目遵循与主项目相同的许可证。